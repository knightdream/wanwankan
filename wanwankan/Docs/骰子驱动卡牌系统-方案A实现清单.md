# 方案 A：骰子驱动技能卡 — 实现清单

> 卡牌 = 技能（有费用）；费用 = 用本回合掷出的骰子支付；打出后仍用 d20/d6 做命中和伤害。

---

## 一、你要做的内容总览

| 大类 | 内容 |
|------|------|
| **1. 数据与配置** | 技能卡数据结构、费用类型、卡组配置、与职业/角色挂钩 |
| **2. 骰子费用系统** | 费用规则（单骰≥N、多骰总和、精确点数等）、能否支付的判定、支付后消耗骰子 |
| **3. 牌组与手牌** | 抽牌堆/弃牌堆/手牌、每回合抽牌数、出牌阶段可打多张（直到不想出或不能出） |
| **4. 战斗流程改造** | 玩家气力满 → 进入出牌阶段（掷骰→展示手牌→选卡+选骰支付→执行效果→可继续或结束回合） |
| **5. 卡牌效果执行** | 攻击/防御/技能/治疗等与现有 CombatUnit、DiceSystem 对接 |
| **6. UI** | 手牌区、本回合骰子区、选卡+选骰支付流程、费用不足灰显 |
| **7. 构筑与成长** | 初始卡组、战后奖励（选卡/删卡/升级卡）— 可后期做 |

下面按「必须先做」和「可后做」分条列出。

---

## 二、数据与配置（必做）

### 2.1 技能卡数据

需要定义「一张卡」包含的字段，建议用 `ScriptableObject` 或配置表，方便策划编辑。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 唯一ID |
| cardName | string | 显示名称 |
| description | string | 描述（可含费用说明） |
| costType | 见下 | 费用类型 |
| costValue | int / int[] | 费用数值（如单骰≥4 则 4，多骰总和≥8 则 8） |
| effectType | 枚举 | 攻击 / 防御 / 技能 / 治疗 / Buff 等 |
| effectParam | 灵活 | 伤害倍率、格挡公式、治疗量、Buff ID 等 |
| targetType | 枚举 | 单体敌人 / 自身 / 全体敌人 等 |
| 可选：稀有度/升级版 | — | 用于奖励与升级 |

**费用类型建议（costType + costValue）：**

- `SingleMin`：消耗 1 个骰子，点数 ≥ costValue（如 4+）
- `SingleExact`：消耗 1 个骰子，点数 = costValue（如必须 5）
- `SumMin`：消耗若干骰子，总和 ≥ costValue（如 2 个骰子总和≥8）
- `Count`：消耗恰好 N 个骰子（任意点数），costValue = N
- `Free`：不消耗骰子（如基础攻击）

**建议**：先实现 `SingleMin` 和 `Free`，再扩展其它。

### 2.2 卡组配置

- **Deck / DeckData**：当前本局使用的牌组（卡牌 ID + 数量，或卡牌引用列表）。
- 与**职业/角色**挂钩：`CharacterConfig` 或类似处增加「初始卡组」引用，战斗开始时用该卡组初始化抽牌堆。

### 2.3 与现有代码的关系

- 不需要改 `CharacterStats`、`DiceSystem` 的现有接口。
- 需要**新脚本**：例如 `SkillCardData`（单卡）、`DeckData`（卡组）、`CardCostType` 枚举。

---

## 三、骰子费用系统（必做）

### 3.1 本回合骰子

- 玩家回合开始（气力满、进入出牌阶段）时：掷 **N 个 d6**（N 可配置，如 5，或由敏捷/装备决定）。
- 保存为「本回合可用骰子列表」，例如 `List<int> currentDice`（每个 1–6）。
- 每次用骰子支付后，从该列表中**移除**已使用的骰子。

### 3.2 费用判定

- 输入：一张卡的 `costType` + `costValue`，当前 `currentDice`。
- 输出：能否支付；若需「选哪几个骰子」，可再实现一个「返回一组可行骰子索引」的接口。
- 实现建议：
  - `SingleMin`：是否存在一个骰子 ≥ costValue。
  - `SumMin`：是否存在若干骰子之和 ≥ costValue（可暴力或简单背包）。
  - `Count`：骰子数量是否 ≥ costValue。
  - `Free`：直接 true。

### 3.3 支付与消耗

- 玩家选定「用哪几个骰子」支付后，从 `currentDice` 中移除这些骰子，再执行卡牌效果。

---

## 四、牌组与手牌（必做）

### 4.1 三堆

- **抽牌堆 drawPile**：开局由卡组洗牌生成；抽牌时从 drawPile 顶取。
- **手牌 hand**：当前可出的牌，有上限（如 5 张或 7 张）。
- **弃牌堆 discardPile**：打出的牌进入弃牌堆；抽牌堆空时，将弃牌堆洗入抽牌堆（杀戮尖塔式）。

### 4.2 回合流程（与战斗结合）

- **战斗开始**：用当前角色卡组初始化 drawPile，hand 和 discardPile 为空；可选先抽满手牌或等回合开始再抽。
- **玩家回合开始（出牌阶段）**：
  1. 掷 N 个 d6 → 得到 `currentDice`。
  2. 若手牌未满，从 drawPile 抽牌至满（或每回合固定抽 X 张，由你定）。
  3. 循环：玩家选一张手牌 → 选若干骰子支付 → 若合法则打出（手牌移除该卡、消耗骰子、执行效果、卡进弃牌堆）；可继续选牌出牌，直到选择「结束出牌」或无法支付任何牌。
  4. 结束出牌 → 清空气力，回合结束（回到 ATB 累积）。

### 4.3 管理器

- 建议一个 **DeckManager**（或 CombatDeckManager）：单局战斗内持有 drawPile / hand / discardPile、currentDice，以及抽牌/出牌/洗牌逻辑。战斗开始时由 CombatManager 或 RoomHandler 初始化。

---

## 五、战斗流程改造（必做）

### 5.1 CombatManager 改动

- **当前**：玩家气力满 → `WaitingInput` → 显示「攻击/防御/技能/物品」→ 选攻击则选目标 → 执行一次攻击 → 回合结束。
- **方案 A**：玩家气力满 → `WaitingInput` 改为「出牌阶段」：
  - 不再直接弹出「攻击/防御/技能/物品」。
  - 调用 DeckManager：掷骰、抽牌（若需要）、显示手牌 + 骰子区。
  - 玩家在 UI 上选卡、选骰子、选目标（若需要），DeckManager 判定费用并执行效果。
  - 执行效果时：若是攻击类，仍调用现有 `CombatUnit.Attack(target)` 或类似（内部继续用 d20+d6）；防御/治疗等同理对接现有或新写的逻辑。
  - 玩家点「结束出牌」或无法再出牌 → 结束回合（气力清零，回到 Running）。

### 5.2 状态与接口

- 可保留 `WaitingInput`，但在该状态下由 **CardPlayUI** 接管输入，而不是原来的四个按钮。
- CombatManager 需要提供或使用：
  - `PlayerPlayCard(card, selectedDiceIndices, target)` 或分步：先选卡+骰子，再选目标，再统一执行。
  - `PlayerEndCardPhase()`：结束出牌阶段。

### 5.3 与 CombatUnit 的衔接

- 攻击卡：支付费用后，选目标，调用 `currentActingUnit.Attack(target)`，无需改 CombatUnit 内部，仍用 d20 命中 + d6 伤害。
- 防御卡：可给 `CombatUnit` 加「本回合格挡值」或调用现有防御逻辑（若有）。
- 技能/治疗：在 CombatUnit 或单独 Effect 脚本里接 DiceSystem（d20/d6）和数值。

---

## 六、卡牌效果执行（必做）

### 6.1 效果类型与执行

| 效果类型 | 执行内容 |
|----------|----------|
| 攻击 | 选单体敌人 → 调用 `currentActingUnit.Attack(target)`（内部已用 d20+d6） |
| 防御 | 掷 1d6+修正 得到格挡值，给当前单位加「本回合格挡」 |
| 技能 | 按 effectParam 掷骰、检定、造成伤害或施加 Buff（可先做 1–2 个具体技能） |
| 治疗 | 掷 1d6 或固定值，给自身或友军回血 |

格挡可在 `CombatUnit` 或 `CharacterStats` 增加 `Block` 字段，受伤时先扣 Block 再扣 HP。

### 6.2 扩展点

- 后续可加「打出时」「弃牌时」等触发器，以及 Buff/Debuff 系统；第一版可只做「打出→立即执行一种效果」。

---

## 七、UI（必做）

### 7.1 需要的新 UI 元素

- **手牌区**：横向一排或弧形，每张卡可点击；显示卡名、费用说明、简要描述。
- **本回合骰子区**：显示本回合掷出的 N 个 d6（数字或骰子图），可点击选择「用于支付」；已选中的高亮，支付后从界面移除或灰显。
- **费用与可出牌**：根据当前 `currentDice` 计算每张手牌是否可出；不可出的灰显或置灰，可出的高亮可点。
- **出牌流程**：点击一张可出牌 → 进入「选骰子」状态（点若干骰子满足费用）→ 若需目标则再选敌人/己方 → 确认打出；取消则回到选牌。
- **结束出牌按钮**：点击后调用 `PlayerEndCardPhase()`，结束回合。

### 7.2 与现有 CombatUI 的关系

- 在 `WaitingInput` 且为玩家时：隐藏或不用原来的「攻击/防御/技能/物品」面板，改为显示「手牌 + 骰子 + 结束出牌」。
- 目标选择可复用现有「点击敌人气力条选目标」的逻辑，只是触发时机改为「打出攻击/技能卡并选好骰子之后」。

### 7.3 编辑器工具（可选）

- 类似 MapUICreator：一键生成「手牌容器 + 骰子区 + 结束按钮」的预制体结构，并挂上脚本引用。

---

## 八、构筑与成长（可后做）

- **初始卡组**：每个职业/角色在 `CharacterConfig` 里配好初始卡组（DeckData）。
- **战后奖励**：选一张新卡加入牌组、删一张卡、升级一张卡（改费用或效果数值）；可放在「地图房间奖励」或单独奖励界面之后再做。
- **商店**：卖卡、删卡、升级卡，与商店房间结合。

这些不阻塞「方案 A 能玩起来」，可排在你把核心出牌 + 骰子支付 + 攻击/防御跑通之后。

---

## 九、效果图补充与扩展 UI（抽牌堆、弃牌堆、道具栏、设置、遗物/被动）

### 9.1 抽牌堆与弃牌堆（UI 展示）
- **抽牌堆**：在手牌区**左侧**显示，一叠卡背 + 剩余张数（如「12」）；抽牌动画起点。
- **弃牌堆**：在手牌区**右侧**或抽牌堆与手牌之间显示，一叠 + 本回合/本局弃牌张数（如「3」）；打出/弃牌动画终点。
- **逻辑**：DeckManager 已有 drawPile/discardPile，只需 UI 绑定数量与位置；可选悬停显示「抽牌堆」「弃牌堆」标签。

### 9.2 道具使用栏（3～5 格，类杀戮尖塔药水栏）
- **位置**：画面右下角或与「结束出牌」按钮同一行，横向 3～5 格（建议 5 格）。
- **用途**：战斗中使用的**消耗品**（药水、卷轴、炸弹等），用一次少一次；点击使用，需符合使用时机（如出牌阶段）。
- **数据**：`ItemSlot` 或 `ConsumableSlot` 列表，每格对应一个道具 ID + 数量；空槽灰显。
- **UI**：每格图标 + 可选数量；悬停显示名称与效果描述。

### 9.3 右上角设置按钮
- **位置**：画面**右上角**，不遮挡行动顺序与敌人。
- **交互**：点击打开**系统设置**面板（音量、画质、键位、语言等）；面板为弹层或全屏半透明。
- **实现**：单独 `SettingsButton` + `SettingsPanel`，与战斗逻辑解耦。

### 9.4 遗物/被动技能 UI（类杀戮尖塔 + 以撒宝物）
- **位置**：**屏幕右侧**，与杀戮尖塔遗物区相同（在敌人/战斗区域右侧），竖直 2～3 列网格，不遮挡角色与敌人。
- **用途**：展示本局获得的**遗物（Relic）**或**被动技能（以撒式宝物）**——常驻增益，不消耗（如「每回合多抽 1 张」「骰子 +1 时伤害 +1」）。
- **与道具栏区分**：道具栏 = 消耗品，用一次少一次；遗物/被动 = 常驻，只展示 + 悬停显示名称与效果，不可点击使用。
- **数据**：`RelicData` / `PassiveData` 列表；每格图标 + 可选层数/等级；新获得时可有简短高亮或飞入动画。
- **设计**：可与艾特拉「命运骰」主题结合（骰子、命运符号）；稀有度用边框/光泽区分（普通/稀有/BOSS）。

详见 `Docs/美术需求文档.md` 中「四、效果图补充：抽牌堆、弃牌堆、道具栏、设置、遗物/被动」。

---

## 十、建议实现顺序

1. **数据**：定义 `SkillCardData`（含 costType/costValue、effectType）、`DeckData`，做 3–5 张示例卡（如：普攻 Free、重击 SingleMin 4、格挡 SingleMin 3）。
2. **费用与骰子**：实现「本回合骰子」的掷骰与存储、`CanPay(card, currentDice)` 和 `Pay(card, selectedDice)`（消耗骰子）。
3. **牌组**：实现 DeckManager（drawPile/hand/discardPile，抽牌、洗牌、出牌时从手牌移除并进弃牌堆）。
4. **战斗流程**：CombatManager 玩家回合改为「出牌阶段」— 掷骰、抽牌、等待出牌或结束；`PlayerPlayCard` / `PlayerEndCardPhase` 对接 DeckManager 和 CombatUnit。
5. **效果**：攻击卡 → `Attack(target)`；防御卡 → 加格挡；其余效果可先做 1 个简单技能。
6. **UI**：手牌区 + 骰子区 + 选卡选骰选目标流程 + 结束出牌；可出牌灰显/高亮。
7. **初始卡组**：角色/职业绑定 DeckData，战斗开始初始化牌组。
8. **后续**：战后奖励、商店、更多费用类型与效果类型。
9. **效果图补充**：抽牌堆/弃牌堆 UI、道具栏 3～5 格、右上角设置、右侧遗物/被动区（见第九章）。

---

## 十一、文件/脚本建议清单

| 脚本/资源 | 职责 |
|-----------|------|
| `SkillCardData.cs`（或 ScriptableObject） | 单卡数据：id、名称、费用类型/数值、效果类型/参数、目标类型 |
| `DeckData.cs` | 卡组：卡牌列表或 ID+数量 |
| `CardCostType.cs` | 费用类型枚举 |
| `CardEffectType.cs` | 效果类型枚举 |
| `DiceCostChecker.cs`（或静态工具） | 判定 CanPay、选骰子、Pay 消耗 |
| `DeckManager.cs` | 单局抽牌堆/手牌/弃牌堆、掷骰、抽牌、出牌、与 CombatManager 通信 |
| `CombatManager` 修改 | 玩家回合进入出牌阶段，调用 DeckManager；提供 PlayerPlayCard、PlayerEndCardPhase |
| `CombatUnit` / `CharacterStats` 可选 | 格挡值、治疗接口（若还没有） |
| `CardPlayUI.cs` 或 `CombatCardUI.cs` | 手牌展示、骰子展示、选卡选骰选目标、结束出牌 |
| 手牌卡预制体、骰子显示预制体 | UI 预制体 |
| 角色/职业配置 | 增加 initialDeck 引用 |
| 抽牌堆/弃牌堆 UI | 绑定 DeckManager 数量，显示在手牌左右 |
| 道具栏 UI（3～5 格） | 消耗品槽位，类杀戮尖塔药水栏 |
| 设置按钮 + 设置面板 | 右上角，系统设置（音量/画质/键位等） |
| 遗物/被动区 UI | 屏幕右侧，常驻增益展示，悬停显示描述 |

按上述顺序做，可以先在战斗里「只出攻击卡 + 防御卡」跑通一局，再逐步加技能卡、道具栏与遗物/被动。

如果你愿意，我可以下一步按你当前项目结构，直接写出 `SkillCardData`、`CardCostType`、`DiceCostChecker` 和 `DeckManager` 的 C# 草稿，以及 CombatManager 需要改动的接口与调用顺序。
