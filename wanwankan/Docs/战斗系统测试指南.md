# 战斗系统测试指南

> 本文档说明如何测试战斗系统的各项功能，包括快速测试和完整流程测试。

---

## 🚀 快速测试方法（推荐）

### 方法1：使用GameManager的测试战斗（最简单）

**步骤：**

1. **打开场景**
   - 打开 `Assets/Scenes/SampleScene.unity` 或 `FightGame.unity`

2. **确保场景中有GameManager**
   - 如果场景中没有 `GameManager`，创建一个空GameObject
   - 添加 `GameManager` 组件（`Assets/Scripts/Core/GameManager.cs`）

3. **配置GameManager（可选）**
   - 在Inspector中设置：
     - `Auto Start Test Battle`：勾选后会自动开始测试战斗
     - `Player Name`：玩家名称（默认"勇者"）
     - `Player STR/AGI/WIS`：玩家属性
     - `Test Enemies`：可以添加自定义敌人配置

4. **运行游戏**
   - 点击Play按钮
   - 如果 `Auto Start Test Battle` 已勾选，战斗会自动开始
   - 如果没有勾选，按 `B` 键开始测试战斗

5. **测试快捷键**
   - `B`：开始测试战斗
   - `T`：测试骰子系统
   - `G`：模拟气力系统
   - `ESC`：强制结束战斗
   - `1-9`：选择目标攻击（战斗中选择敌人）
   - `D`：防御

---

### 方法2：通过地图系统进入战斗（完整流程）

**步骤：**

1. **设置场景**
   - 打开 `Assets/Scenes/SampleScene.unity`
   - 确保场景中有以下GameObject和组件：
     - `GameManager`（`WanWanKan.Core.GameManager`）
     - `MapManager`（`WanWanKan.Map.MapManager`）
     - `RoomHandler`（`WanWanKan.Map.RoomHandler`）
     - `CombatManager`（`WanWanKan.Combat.CombatManager`）
     - `CombatVisualEffects`（`WanWanKan.Combat.CombatVisualEffects`）
     - `CharacterSelection`（`WanWanKan.Character.CharacterSelection`）
     - `CombatUI`（`WanWanKan.UI.CombatUI`）

2. **确保CombatUI已配置**
   - 如果还没有CombatUI预制体，运行菜单：
     - `WanWanKan → 一键创建完整战斗UI`
   - 或者手动创建并配置CombatUI组件

3. **运行游戏**
   - 点击Play按钮
   - MapManager会自动生成地图
   - 进入起点房间后，移动到战斗房间
   - 进入战斗房间时，RoomHandler会自动触发战斗

4. **测试战斗**
   - 观察气力条填充动画
   - 点击"攻击"按钮，然后点击敌人气力条选择目标
   - 观察伤害数字、攻击动画、受击动画
   - 测试暴击效果（投出20时）
   - 测试死亡动画

---

## 🎮 测试检查清单

### ✅ 基础功能测试

- [ ] **战斗启动**
  - [ ] 战斗能正常开始
  - [ ] 玩家和敌人单位正确创建
  - [ ] 气力条UI正确显示

- [ ] **气力系统**
  - [ ] 气力条平滑填充
  - [ ] 敏捷高的单位行动更快
  - [ ] 气力满时显示就绪指示器

- [ ] **攻击系统**
  - [ ] 点击"攻击"按钮能进入目标选择模式
  - [ ] 点击敌人气力条能选择目标
  - [ ] 攻击能造成伤害
  - [ ] 未命中时显示"Miss"

- [ ] **防御系统**
  - [ ] 点击"防御"按钮能防御
  - [ ] 防御时减少伤害（如果已实现）

- [ ] **战斗结束**
  - [ ] 所有敌人被击败后显示胜利面板
  - [ ] 玩家被击败后显示失败面板

### ✅ 视觉特效测试

- [ ] **伤害数字**
  - [ ] 普通伤害显示红色数字
  - [ ] 暴击伤害显示金色数字，更大字体
  - [ ] 治疗显示绿色数字
  - [ ] 数字向上飘动并淡出

- [ ] **攻击动画**
  - [ ] 攻击者单位放大+震动
  - [ ] 动画流畅自然

- [ ] **受击动画**
  - [ ] 受击者闪烁+震动
  - [ ] 暴击时震动更强烈

- [ ] **死亡动画**
  - [ ] 单位死亡时渐隐+缩放+旋转
  - [ ] 动画完成后单位消失

- [ ] **行动顺序预览**
  - [ ] 显示未来6个行动单位
  - [ ] 玩家显示蓝色，敌人显示红色

### ✅ 角色选择测试

- [ ] **角色系统**
  - [ ] CharacterSelection正确创建单例
  - [ ] 默认有3个职业（战士/盗贼/法师）
  - [ ] 单次战斗只有1个主角
  - [ ] 角色属性正确应用到战斗单位

### ✅ 战斗日志测试

- [ ] **日志显示**
  - [ ] 战斗开始/结束记录
  - [ ] 每个回合记录
  - [ ] 伤害记录
  - [ ] 死亡记录
  - [ ] 日志自动滚动到底部

---

## 🐛 常见问题排查

### 问题1：战斗没有开始

**可能原因：**
- CombatManager未创建
- GameManager的`Auto Start Test Battle`未勾选
- 场景中没有必要的组件

**解决方法：**
1. 检查Hierarchy中是否有`CombatManager` GameObject
2. 如果没有，GameManager会自动创建
3. 或者手动创建：`GameObject → Create Empty → Add Component → CombatManager`
4. 确保GameManager的`Auto Start Test Battle`已勾选，或按`B`键手动开始

---

### 问题2：UI没有显示

**可能原因：**
- CombatUI未创建或未配置
- UI预制体引用丢失

**解决方法：**
1. 运行菜单：`WanWanKan → 一键创建完整战斗UI`
2. 或者运行：`WanWanKan → 自动绑定CombatUI引用`
3. 检查CombatUI组件是否在场景中
4. 检查所有UI引用是否已正确设置

---

### 问题3：伤害数字没有显示

**可能原因：**
- CombatVisualEffects未创建
- 伤害数字预制体未设置

**解决方法：**
1. 确保场景中有`CombatVisualEffects` GameObject
2. CombatVisualEffects会自动创建默认伤害数字预制体
3. 检查Console是否有错误信息

---

### 问题4：角色选择不生效

**可能原因：**
- CharacterSelection未创建
- RoomHandler未使用CharacterSelection

**解决方法：**
1. 确保场景中有`CharacterSelection` GameObject
2. CharacterSelection会自动创建单例
3. 检查RoomHandler是否正确使用CharacterSelection创建玩家单位

---

### 问题5：地图系统不工作

**可能原因：**
- MapManager未创建
- RoomHandler未订阅事件

**解决方法：**
1. 确保场景中有`MapManager` GameObject
2. 确保场景中有`RoomHandler` GameObject
3. 检查Console是否有错误信息

---

## 📊 调试信息

### 控制台日志

战斗系统会输出详细的调试信息：

```
[GameManager] 开始测试战斗...
=== 战斗单位信息 ===
玩家: 勇者 [Player] HP:26/26 AG:0/100 SPD:40
敌人: 哥布林 [Enemy] HP:20/20 AG:0/100 SPD:34
====================
[CombatManager] 战斗开始！玩家: 1, 敌人: 2
[Combat] 勇者 攻击 哥布林: 15 vs 13
[Combat] 命中！勇者 对 哥布林 造成 8 点伤害
[CombatVisualEffects] 显示伤害数字: -8
```

### 调试UI（GameManager）

运行游戏时，左上角会显示调试信息：
- 快捷键说明
- 战斗状态
- 所有单位信息（HP、气力、就绪状态）

---

## 🎯 测试场景设置

### 最小测试场景

创建一个新场景，添加以下GameObject：

```
Scene
├── GameManager (GameManager组件)
├── CombatManager (CombatManager组件)
├── CombatVisualEffects (CombatVisualEffects组件)
├── CharacterSelection (CharacterSelection组件)
└── Canvas
    └── CombatUI (CombatUI组件)
```

### 完整测试场景

```
Scene
├── GameManager (GameManager组件)
├── DiceSystem (DiceSystem组件)
├── CombatManager (CombatManager组件)
├── CombatVisualEffects (CombatVisualEffects组件)
├── CharacterSelection (CharacterSelection组件)
├── MapManager (MapManager组件)
├── RoomHandler (RoomHandler组件)
└── Canvas
    ├── CombatUI (CombatUI组件)
    └── MapUI (MapUI组件，可选)
```

---

## 🔧 高级测试

### 测试不同角色

1. 在代码中或Inspector中修改CharacterSelection
2. 添加新角色：
```csharp
CharacterConfig newChar = new CharacterConfig(
    "archer", "弓箭手", 
    5, 8, 7, 
    "远程攻击职业"
);
CharacterSelection.Instance.AddCharacter(newChar);
CharacterSelection.Instance.SelectCharacter("archer");
```

### 测试不同敌人

1. 在GameManager的Inspector中添加`Test Enemies`
2. 设置敌人的名称和属性
3. 运行游戏，按`B`键开始战斗

### 测试视觉特效参数

1. 选中`CombatVisualEffects` GameObject
2. 在Inspector中调整参数：
   - `Damage Number Lifetime`：伤害数字显示时长
   - `Attack Shake Intensity`：攻击震动强度
   - `Hit Flash Duration`：受击闪烁时长
   - 等等...

---

## 📝 测试报告模板

测试完成后，可以记录以下信息：

```
测试日期：2024-12-18
测试场景：SampleScene
测试人员：[你的名字]

✅ 通过的功能：
- 战斗启动 ✓
- 攻击系统 ✓
- 伤害数字显示 ✓
- 攻击/受击动画 ✓
...

❌ 发现的问题：
- [问题描述]
- [复现步骤]
- [预期行为]
- [实际行为]

💡 改进建议：
- [建议内容]
```

---

## 🎬 视频录制建议

如果可能，录制测试视频，展示：
1. 战斗启动流程
2. 攻击和受击动画
3. 伤害数字显示
4. 暴击效果
5. 死亡动画
6. 战斗结束

---

*文档版本：1.0*  
*最后更新：2024-12-18*
