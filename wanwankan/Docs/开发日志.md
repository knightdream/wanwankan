# 汪汪看 - 开发日志

> 桌游风格 + 简化TRPG + Roguelike 游戏

---

## 📅 2024-12-17 - 随机地图生成系统实现

### ✅ 今日完成

#### 🗺️ 地图系统核心实现
- [x] 创建 `Assets/Scripts/Map/` 文件夹结构
- [x] **RoomType枚举** - 7种房间类型（起点、战斗、宝藏、事件、商店、休息、BOSS）
- [x] **Room类** - 房间数据结构（ID、类型、位置、连接关系、深度、状态）
- [x] **MapLayout类** - 地图布局管理（房间字典、起点/BOSS房间、当前房间、导航）
- [x] **MapGenerator类** - 随机地图生成器
  - 网格布局算法（主路径 + 分支路径）
  - 房间类型加权随机分配（战斗40%、事件25%、宝藏15%、商店10%、休息10%）
  - BFS深度计算（房间距离起点的最短距离）
  - 房间连通性保证（确保所有房间可达）
- [x] **MapManager类** - 地图管理器（单例）
  - 地图生成与切换
  - 房间进入与完成
  - 房间导航（获取可访问房间）
  - 楼层进度管理
  - 事件系统（OnRoomEntered、OnRoomCompleted、OnMapGenerated）

#### 📦 房间数据类
- [x] **BattleRoomData** - 战斗房间数据（敌人ID列表、战斗奖励）
- [x] **EventRoomData** - 事件房间数据（事件ID、选择结果）
- [x] **TreasureRoomData** - 宝藏房间数据（物品列表、金币）
- [x] **ShopRoomData** - 商店房间数据（商品列表、折扣）
- [x] **RestRoomData** - 休息房间数据（HP恢复百分比、休息代价）

#### 🎯 地图生成算法特点
- **房间数量**：每层5-7个房间（可配置）
- **布局方式**：网格布局 + 随机分支连接
- **连通性保证**：确保起点到BOSS房间有路径
- **分支路径**：随机添加相邻房间连接（增加探索选择）
- **深度限制**：分支连接限制在2格距离内（避免跨层连接）

#### 📁 文件结构
```
Assets/Scripts/Map/
├── RoomType.cs           # 房间类型枚举
├── Room.cs               # 房间数据类
├── MapLayout.cs          # 地图布局类
├── MapGenerator.cs       # 地图生成器（静态类）
├── MapManager.cs         # 地图管理器（单例）
├── BattleRoomData.cs     # 战斗房间数据
├── EventRoomData.cs      # 事件房间数据
├── TreasureRoomData.cs   # 宝藏房间数据
├── ShopRoomData.cs       # 商店房间数据
└── RestRoomData.cs       # 休息房间数据
```

#### 🔧 技术实现
- 使用 `Dictionary<int, Room>` 管理房间（O(1)查找）
- 使用 `List<int>` 存储房间连接关系（邻接表）
- 使用BFS算法计算房间深度
- 使用加权随机算法分配房间类型
- 单例模式管理地图状态
- 事件驱动架构（房间进入/完成事件）

#### 🖥️ 地图UI系统实现
- [x] **MapUI类** - 地图UI管理器
  - 地图面板显示/隐藏
  - 房间节点可视化
  - 连接线绘制
  - 房间状态颜色区分（起点/当前/已访问/未访问/BOSS/可访问）
  - 快捷键支持（默认M键打开/关闭）
  - 自动刷新（地图生成/房间进入/房间完成时）
- [x] **RoomNodeUI类** - 房间节点UI组件
  - 房间图标显示
  - 房间名称显示
  - 高亮效果（当前房间）
  - 颜色状态管理
- [x] **MapUICreator编辑器工具** - 地图UI预制体创建工具
  - 一键创建完整地图UI
  - 创建地图面板（带标题栏、关闭按钮、滚动区域）
  - 创建房间节点预制体
  - 创建连接线预制体
  - 自动应用中文字体

#### 🎨 地图UI特性
- **房间状态颜色**：
  - 🟢 起点房间（绿色）
  - 🟡 当前房间（金色，带高亮）
  - 🔵 未访问房间（蓝色）
  - ⚪ 已访问房间（灰色）
  - 🟡 可访问房间（浅黄色）
  - 🔴 BOSS房间（红色）
- **交互方式**：
  - 按 `M` 键打开/关闭地图
  - 点击关闭按钮关闭地图
  - 地图自动跟随房间状态更新
- **布局**：
  - 网格布局（基于房间Position）
  - 可滚动查看大地图
  - 房间节点间距可配置

#### 📁 UI文件结构
```
Assets/Scripts/UI/
├── MapUI.cs              # 地图UI管理器
└── RoomNodeUI.cs         # 房间节点UI组件

Assets/Scripts/Editor/
└── MapUICreator.cs      # 地图UI创建工具

Assets/Prefabs/UI/
├── MapUI.prefab          # 地图UI预制体
├── RoomNode.prefab       # 房间节点预制体
└── ConnectionLine.prefab # 连接线预制体
```

#### 📝 待集成功能
- [ ] 房间内容生成（敌人、事件、物品）
- [ ] 点击房间节点进入房间（导航功能）
- [ ] 与战斗系统集成
- [ ] 与任务系统集成
- [ ] 地图存档/加载

详见 `Assets/Scripts/Map/` 和 `Assets/Scripts/UI/` 目录

---

## 📅 2024-12-17 - 故事与任务系统设计

### ✅ 今日完成

#### 📖 故事设定文档
- [x] 完整世界观设定（艾特拉世界、命运之力）
- [x] 主线故事（四幕结构 + 多结局）
- [x] 角色背景（战士/盗贼/法师）
- [x] 重要NPC设定
- [x] 敌人与BOSS设定（7层守门者）
- [x] 随机事件故事示例
- [x] 世界琐闻（谚语、货币、历法、组织）

详见 `Docs/故事设定.md`

#### 📋 任务系统设计
- [x] 蛛网式任务设计（任务间互相关联、对立、依赖）
- [x] 对立任务机制（完成A则锁定B）
- [x] 分支任务机制（可提前交付但失去后续）
- [x] 善恶度系统（-100~+100，影响结局和奖励）
- [x] 共享物品机制（唯一物品需谨慎分配）
- [x] 任务递减设计（新手村15个→终章3个）
- [x] 第一章晨曦镇15个任务完整设计
- [x] 第二章贪婪矿洞任务框架
- [x] 第七章终章任务设计
- [x] 全部任务奖励一览（武器/防具/骰子/技能/称号）
- [x] 唯一物品与共享物品清单
- [x] 任务对立关系图

详见 `Docs/任务系统.md`（v3.0 周目优化版）

#### 📋 任务系统优化（v3.0）
- [x] 重新设计周目完成机制
- [x] **一周目可完成所有非互斥任务（51个）**
- [x] **二周目可完成所有互斥任务另一线（8个）**
- [x] 明确8对互斥任务
- [x] 区分互斥任务🔒 vs 分支选择🔀 vs 连锁任务🔗
- [x] 修复物品冲突问题：
  - S05不再需要【银狐皮】，改为普通【狐狸皮】
  - S40不再需要【月光花】，只需【生命种子】
  - 增加第二个【火焰精魄】获取途径（S35）
- [x] 添加周目完成规划表

#### 📦 道具系统设计
- [x] 创建道具系统文档 `Docs/道具系统.md`
- [x] 5大道具分类：材料(35)、武器(28)、装备(32)、药材(24)、特殊(26)
- [x] 总计145个道具
- [x] 道具分类预览表
- [x] 道具详细内容表
- [x] 任务道具标注与索引
- [x] 唯一物品总览

#### 👹 怪物与成长系统设计
- [x] 创建怪物与成长系统文档 `Docs/怪物与成长系统.md`
- [x] 角色成长系统（40级上限，每级+3成长点）
- [x] 经验值系统（升级所需经验表）
- [x] 8个章节共39种普通怪、15种精英怪、7个小BOSS、7个守门者
- [x] 完整怪物数值表（HP/ATK/DEF/SPD/经验/金币）
- [x] 完整怪物掉落表（必掉/概率/稀有）
- [x] BOSS详细设计（最终BOSS三阶段）
- [x] 掉落系统公式（幸运值、贪婪加成）
- [x] 经济平衡分析（收入~51,300/支出~34,000）
- [x] 数值平衡参考（玩家vs怪物伤害、BOSS战斗时长）

#### 🎭 吟游诗人与诗歌设计
- [x] 创建吟游诗人与诗歌文档 `Docs/吟游诗人与诗歌.md`
- [x] 吟游诗人角色设定（塞拉斯·织语者）
- [x] 8个章节主题诗歌（每章1-2首）
- [x] 勇者传说背景诗歌（埃隆的完整故事）
- [x] 5首隐藏任务线索诗歌
- [x] 情境诗歌（善恶值、濒死、BOSS战后）
- [x] 诗歌总览表（19首诗歌索引）
- [x] 所有诗歌使用隐喻手法暗示任务和剧情

#### 👤 NPC系统设计
- [x] 创建NPC系统文档 `Docs/NPC系统.md`
- [x] NPC分类系统（剧情/任务/商人/功能/流动）
- [x] 好感度系统（-100~100，6个等级）
- [x] 阵营系统（7个阵营及关系）
- [x] 对话系统设计（6种对话类型，6种选项类型）
- [x] 主要剧情NPC详细设计（5个核心NPC）
- [x] 功能性NPC设计（商店/锻造/治疗等）
- [x] 8个章节NPC列表（共79个NPC）
- [x] 重点NPC详细背景故事
- [x] 互斥NPC关系表
- [x] 可招募/同行NPC系统

#### 📄 游戏设计文档更新
- [x] 添加任务系统概述章节

---

## 📅 2024-12-16 - 项目启动 & 核心战斗系统

### 🎯 游戏定位
- **类型**：桌游风格，类似DND但系统更简单，含Roguelike元素
- **核心理念**："骰子决定命运，选择决定未来"
- **玩法**：单人/多人桌游冒险，随机地下城探险，骰子检定，永久死亡+解锁

### ✅ 今日完成

#### 1. 核心系统搭建
- [x] 骰子系统 (d6, d20, d100)
- [x] 角色属性系统 (STR, AGI, WIS)
- [x] ATB战斗系统（气力值）
- [x] 战斗管理器

#### 2. UI系统
- [x] 气力条UI + HP条显示
- [x] 战斗菜单（攻击/防御/技能/物品）
- [x] 行动顺序预览
- [x] 战斗日志
- [x] 胜利/失败面板

#### 3. 目标选择优化
- [x] 点击敌人气力条直接选择目标（不再弹出按钮列表）
- [x] 可选目标高亮显示（黄色）
- [x] 鼠标悬停效果（白色）

#### 4. HP动画系统
- [x] HP条实时显示
- [x] 受伤时血条平滑减少动画
- [x] 伤害延迟条（白色追赶效果）
- [x] HP数字滚动变化
- [x] 血量颜色渐变（绿→黄→红）

#### 5. 死亡动画
- [x] 单位死亡时UI渐隐消失
- [x] 配合缩小动画效果
- [x] 自动销毁死亡单位UI

#### 6. 中文支持
- [x] 导入思源黑体
- [x] UI创建工具自动应用中文字体

---

## ⚔️ 战斗系统设计

### 骰子系统
| 骰子 | 用途 |
|------|------|
| **d6** | 普通骰子，伤害计算 |
| **d20** | 特殊骰子，攻击/技能检定，1=大失败，20=大成功 |
| **d100** | 概率事件判定 |

### 检定规则
```
投 1d20 + 属性修正 >= 难度值 = 成功

难度参考：
- 简单: 10
- 普通: 15
- 困难: 20
```

### ATB战斗系统（气力系统）
- **气力恢复速度** = 10 + 敏捷 × 3
- 气力满 (100) 时可以行动
- 行动后气力清零重新积累
- **特点**：敏捷高的单位行动更频繁

**示例**：
- 玩家敏捷10 → 速度40 → 约2.5秒行动一次
- 怪物敏捷27 → 速度91 → 约1.1秒行动一次
- 结果：怪物行动约2次，玩家行动1次

### HP动画系统
```
攻击命中流程：
1. 绿色HP条立即开始平滑减少
2. 0.3秒后白色伤害条开始追赶
3. HP数字滚动变化（如 20→15）
4. 血条颜色随百分比变化：
   - 100%-50%: 绿色→黄色
   - 50%-0%: 黄色→红色

死亡流程：
1. HP归零触发死亡
2. 等待0.5秒
3. UI渐隐（1秒）+ 缩小动画
4. 销毁UI对象
```

---

## 📊 属性系统

### 三大属性
| 属性 | 作用 | 公式 |
|------|------|------|
| **STR (力量)** | 物理伤害、最大HP | HP = 10 + STR × 2 |
| **AGI (敏捷)** | 气力恢复、闪避 | 速度 = 10 + AGI × 3 |
| **WIS (智慧)** | 魔法伤害、感知 | 待扩展 |

### 属性修正值
```
修正值 = 属性值 - 5
用于骰子检定时的加成
```

---

## 🗂️ 项目结构

```
Assets/Scripts/
├── Core/
│   ├── DiceSystem.cs       # 骰子系统
│   └── GameManager.cs      # 游戏管理器
├── Character/
│   └── CharacterStats.cs   # 角色属性
├── Combat/
│   ├── CombatUnit.cs       # 战斗单位
│   └── CombatManager.cs    # ATB战斗管理器
├── Map/
│   ├── RoomType.cs         # 房间类型枚举
│   ├── Room.cs             # 房间数据类
│   ├── MapLayout.cs        # 地图布局类
│   ├── MapGenerator.cs     # 地图生成器
│   ├── MapManager.cs       # 地图管理器
│   ├── BattleRoomData.cs   # 战斗房间数据
│   ├── EventRoomData.cs    # 事件房间数据
│   ├── TreasureRoomData.cs # 宝藏房间数据
│   ├── ShopRoomData.cs     # 商店房间数据
│   └── RestRoomData.cs     # 休息房间数据
├── UI/
│   ├── ActionGaugeUI.cs    # 气力条+HP条UI（含动画）
│   ├── CombatUI.cs         # 战斗界面管理
│   └── DiceRollUI.cs       # 骰子动画
└── Editor/
    ├── CombatUICreator.cs  # UI创建工具
    └── CombatUIBinder.cs   # UI绑定工具
```

---

## 🎮 操作方式

### 键盘快捷键（调试用）
| 按键 | 功能 |
|------|------|
| T | 测试骰子 |
| B | 开始战斗 |
| G | 模拟气力系统 |
| 1-9 | 选择敌人攻击 |
| D | 防御 |
| ESC | 强制结束战斗 |

### 鼠标操作
| 操作 | 效果 |
|------|------|
| 点击「攻击」按钮 | 进入目标选择模式 |
| 点击敌人气力条 | 选择该敌人为目标 |
| 鼠标悬停敌人 | 高亮显示 |

---

## 📝 待开发功能

### Phase 2: 地图探索
- [x] 房间生成算法 ✅
- [ ] 地图UI & 导航
- [x] 多种房间类型（战斗、宝藏、事件、商店、休息）✅

### Phase 3: 内容丰富
- [ ] 技能系统
- [ ] 物品/装备系统
- [ ] 事件系统（随机遭遇）
- [ ] 多个职业
- [ ] BOSS战

### Phase 4: Meta进度
- [ ] 永久解锁系统
- [ ] 存档系统
- [ ] 传承点数

---

## 💡 设计思路

### 职业设计（初步）
| 职业 | 初始属性 | 特殊能力 |
|------|---------|---------|
| 战士 | STR 3, AGI 2, WIS 1 | 每场战斗第一击+2伤害 |
| 盗贼 | STR 1, AGI 3, WIS 2 | 可选择逃跑，100%成功 |
| 法师 | STR 1, AGI 2, WIS 3 | 携带1个免费法术卷轴 |

### 房间类型分布
```
🗡️ 战斗房 (40%)
💰 宝藏房 (15%)
🎭 事件房 (25%)
🏪 商店房 (10%)
⛺ 休息房 (10%)
```

### Roguelike元素
- 随机地图生成
- 永久死亡
- 每局不同体验
- Meta升级解锁

---

## 🔧 技术笔记

### 中文字体设置
- 字体路径：`Assets/Resources/Font/SourceHanSansSC-Normal SDF.asset`
- 设置默认：Edit → Project Settings → TextMesh Pro → Settings → Default Font Asset
- UI创建器已自动应用中文字体

### Unity菜单工具
| 菜单 | 功能 |
|------|------|
| `WanWanKan/创建战斗UI` | 打开UI创建窗口（可单独创建组件） |
| `WanWanKan/一键创建完整战斗UI` | 直接创建所有UI |
| `WanWanKan/自动绑定CombatUI引用` | 自动设置UI组件引用 |

### ActionGaugeUI 组件功能
- 气力条显示与动画
- HP条显示与伤害动画
- 点击选择目标
- 死亡渐隐动画

---

## 📌 问题记录

### 已解决
1. ✅ TMP默认字体不支持中文 → 使用思源黑体 + UI创建器自动应用
2. ✅ CombatUI错过OnCombatStart事件 → 延迟订阅+主动检查
3. ✅ UI预制体引用丢失 → 创建自动绑定工具
4. ✅ 目标选择不直观 → 改为直接点击敌人气力条
5. ✅ 缺少HP显示 → 添加HP条+伤害动画
6. ✅ 死亡无反馈 → 添加渐隐销毁动画

### 待解决
- （暂无）

---

## 📸 界面预览

```
┌─────────────────────────────────────────────────┐
│      [行动顺序: 🔵🔴🔵🔴🔵🔴]                    │
│                                                 │
│ ┌───────────────┐        ┌───────────────┐     │
│ │ 勇者          │        │ 哥布林        │     │
│ │ ████████████ HP│        │ ██████░░░░ HP │     │
│ │ ████████░░ 气力│        │ ████░░░░░░ 气力│     │
│ └───────────────┘        └───────────────┘     │
│                                                 │
│           "选择行动" / "点击敌人选择目标"         │
│                                                 │
│ ┌─────────────────┐                             │
│ │ 战斗日志        │                             │
│ │ > 勇者攻击哥布林│                             │
│ │ > 造成5点伤害   │                             │
│ └─────────────────┘                             │
│                                                 │
│      [攻击] [防御] [技能] [物品]                │
└─────────────────────────────────────────────────┘
```

---

*最后更新：2024-12-16*
